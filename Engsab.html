<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق اللغة الإنجليزية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS العام والخاص بواجهة التفعيل */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: #e3f2fd;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* تأكد من أن الـ body يغطي الشاشة بالكامل */
            overflow: hidden; /* لمنع ظهور شريط التمرير إذا كان هناك محتوى زائد عن الحاجة */
        }
        
        /* الأقسام الرئيسية للتطبيق، قسم التفعيل وقسم المدرس */
        .app-section {
            display: none; /* يتم إخفاء جميع أقسام التطبيق افتراضياً */
            width: 100%;
            height: 100%;
            justify-content: center; /* لتوسيط المحتوى داخل القسم */
            align-items: center; /* لتوسيط المحتوى داخل القسم */
            opacity: 0; /* لتأثير التلاشي */
            transition: opacity 0.5s ease-in-out; /* تأثير التلاشي */
            position: absolute; /* لجعل الأقسام تتداخل فوق بعضها البعض وتسمح بالتبديل السلس */
            top: 0;
            left: 0;
        }
        .app-section.active {
            display: flex; /* إظهار القسم النشط */
            opacity: 1; /* لجعلها مرئية */
            position: relative; /* لتمكين وضع العناصر الفرعية ضمن تدفق المستند الطبيعي */
        }
        
        /* أنماط واجهة التفعيل */
        #activationSection {
            background-image: linear-gradient(to bottom right, #e3f2fd, #bbdefb); /* تدرج لوني للخلفية */
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }
        #activationSection .container {
            background-color: #ffffff;
            padding: 40px; /* زيادة الحشوة */
            border-radius: 20px; /* زيادة انحناء الزوايا */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); /* ظل أوضح */
            max-width: 450px; /* زيادة عرض الحاوية */
            width: 100%;
            border: 2px solid #90caf9; /* حدود لطيفة */
            box-sizing: border-box;
            animation: fadeIn 0.8s ease-out; /* تأثير ظهور للحاوية */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #activationSection h2 {
            color: #1565c0; /* لون أزرق أغمق */
            margin-bottom: 25px; /* مسافة سفلية أكبر */
            font-size: 28px; /* حجم خط أكبر */
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1); /* ظل نص خفيف */
        }
        #activationSection p {
            font-size: 17px;
            color: #555;
            margin-bottom: 15px;
        }
        #activationSection input[type="text"] {
            width: calc(100% - 22px);
            padding: 15px; /* زيادة الحشوة */
            margin: 12px 0; /* زيادة المسافة */
            border: 2px solid #bbdefb; /* حدود أزرق فاتح */
            border-radius: 10px; /* زوايا مستديرة أكثر */
            box-sizing: border-box;
            font-size: 17px;
            text-align: center;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #activationSection input[type="text"]:focus {
            outline: none;
            border-color: #42a5f5; /* حدود زرقاء عند التركيز */
            box-shadow: 0 0 0 4px rgba(66, 165, 245, 0.2); /* ظل تركيز */
        }
        #activationSection button {
            background-image: linear-gradient(to right, #2196f3, #1565c0); /* تدرج لوني للأزرار */
            color: #ffffff;
            padding: 14px 25px; /* زيادة الحشوة */
            border: none;
            border-radius: 10px; /* زوايا مستديرة أكثر */
            cursor: pointer;
            font-size: 18px; /* حجم خط أكبر */
            font-weight: bold;
            transition: all 0.3s ease; /* انتقال سلس لجميع الخصائص */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* ظل للأزرار */
            margin-top: 15px; /* مسافة علوية للزر */
        }
        #activationSection button:hover {
            transform: translateY(-3px) scale(1.02); /* تأثير رفع وتكبير خفيف */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3); /* ظل أكبر عند التحويم */
        }
        #activationSection button:active {
            transform: translateY(0); /* العودة عند النقر */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #activationSection .small-button {
            background-color: #4caf50; /* لون أخضر لزر الشراء */
            font-size: 14px;
            padding: 10px 18px;
            border-radius: 8px;
            margin-top: 20px;
        }
        #activationSection .small-button:hover {
            background-color: #43a047;
            transform: translateY(-2px) scale(1.03);
        }
        #activationSection .small-button:active {
            transform: translateY(0);
        }
        #activationSection #resultMessage {
            margin-top: 20px;
            font-size: 17px;
            color: #d32f2f; /* لون أحمر للرسائل */
            font-weight: bold;
        }

        /* أنماط المودال المحسنة */
        #activationSection .modal {
            background-color: rgba(0, 0, 0, 0.6); /* خلفية أغمق للمودال */
            backdrop-filter: blur(5px); /* تأثير ضبابي للخلفية */
            -webkit-backdrop-filter: blur(5px); /* لدعم الويب كيت */
            transition: background-color 0.3s, backdrop-filter 0.3s;
            opacity: 0;
            visibility: hidden;
            display: flex;
            position: fixed;
        }
        #activationSection .modal.show { /* class لتفعيل الإظهار */
            opacity: 1;
            visibility: visible;
        }
        #activationSection .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            width: 85%;
            max-width: 550px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9); /* تبدأ أصغر */
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            position: relative; /* لتمكين وضع أيقونة الواتساب المطلقة */
        }
        #activationSection .modal.show .modal-content {
            transform: scale(1); /* تكبر للحجم الطبيعي */
            opacity: 1;
        }
        #activationSection .modal-content h3 {
            color: #0288d1;
            font-size: 26px;
            margin-bottom: 20px;
        }
        #activationSection .modal-content p {
            font-size: 18px; /* حجم خط أكبر للرسالة */
            color: #333;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        /* تعديلات على أيقونة الواتساب في المودال */
        #activationSection .modal-content .whatsapp-icon-large {
            color: #25D366; /* لون واتساب أخضر */
            font-size: 5rem; /* أيقونة كبيرة جداً */
            margin-bottom: 20px;
            animation: bounceIn 0.8s ease-out; /* تأثير ظهور لأيقونة الواتساب */
            display: block; /* لضمان أخذها سطر كامل وتوسيطها */
            margin-left: auto;
            margin-right: auto;
        }
        /* زر التواصل المحسن */
        #activationSection .modal-content .contact-whatsapp-btn {
            background-color: #25D366; /* أخضر واتساب */
            color: #ffffff;
            padding: 15px 30px;
            border-radius: 30px; /* زر دائري أكثر */
            font-size: 20px;
            font-weight: bold;
            display: inline-flex; /* لجعل الأيقونة والنص في سطر واحد */
            align-items: center;
            gap: 10px; /* مسافة بين الأيقونة والنص */
            text-decoration: none;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4); /* ظل أخضر */
        }
        #activationSection .modal-content .contact-whatsapp-btn:hover {
            background-color: #1DA851; /* أخضر أغمق عند التحويم */
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 211, 102, 0.6);
        }
        #activationSection .modal-content .contact-whatsapp-btn i {
            font-size: 24px;
        }
        #activationSection .modal-content .contact-info-text {
            font-size: 16px;
            color: #666;
            margin-top: 20px;
        }

        @keyframes bounceIn {
            0%, 20%, 40%, 60%, 80%, 100% {
                animation-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
            }
            0% { opacity: 0; transform: scale3d(0.3, 0.3, 0.3); }
            20% { transform: scale3d(1.1, 1.1, 1.1); }
            40% { transform: scale3d(0.9, 0.9, 0.9); }
            60% { opacity: 1; transform: scale3d(1.03, 1.03, 1.03); }
            80% { transform: scale3d(0.97, 0.97, 0.97); }
            100% { opacity: 1; transform: scale3d(1, 1, 1); }
        }

        #activationSection .close-modal {
            font-size: 30px;
            color: #616161;
            transition: color 0.3s;
        }
        #activationSection .close-modal:hover {
            color: #212121;
        }

        /* CSS الخاص بواجهة المدرس (الشات بوت) - يبقى كما هو في معظمه */
        #teacherAppSection {
            flex-direction: column; /* ليكون عمودياً مثل تصميم الشات */
            width: 100vw; 
            height: 100vh;
            position: fixed; 
            top: 0;
            left: 0;
        }
        #teacherAppSection .chat-container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background-color: #6b46c1;
            color: #ffffff;
            padding: 1.5rem;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .chat-history {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scroll-behavior: smooth;
        }

        .message-bubble {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            max-width: 85%;
        }

        .message-bubble.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-bubble.ai {
            align-self: flex-start;
            flex-direction: row;
        }

        .message-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.25rem;
            color: #ffffff;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background-color: #4c51bf;
        }

        .message-avatar.ai {
            background-color: #805ad5;
        }

        .message-content {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .message-bubble.user .message-content {
            background-color: #e0e7ff;
            color: #1a202c;
            border-bottom-right-radius: 0.25rem;
        }

        .message-bubble.ai .message-content {
            background-color: #f3e8ff;
            color: #2d3748;
            border-bottom-left-radius: 0.25rem;
            padding-top: 2rem;
        }

        .chat-input-area {
            display: flex;
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
            background-color: #ffffff;
            gap: 0.75rem;
        }

        .chat-input-area textarea {
            flex-grow: 1;
            border: 1px solid #cbd5e0;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            resize: none;
            min-height: 2.75rem;
            max-height: 150px;
            overflow-y: auto;
            transition: all 0.2s ease-in-out;
        }

        .chat-input-area textarea:focus {
            outline: none;
            border-color: #805ad5;
            box-shadow: 0 0 0 2px rgba(128, 90, 213, 0.2);
        }

        .chat-input-area button {
            background-color: #805ad5;
            color: #ffffff;
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
            font-size: 1.125rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .chat-input-area button:hover {
            background-color: #6b46c1;
            transform: translateY(-1px);
        }

        .chat-input-area button:active {
            transform: translateY(0);
        }

        /* Loading indicator styles */
        .loading-chat-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            align-self: flex-start;
            max-width: 85%;
        }

        .loading-chat-indicator .message-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #f3e8ff;
            color: #2d3748;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Structured translation styles */
        .structured-translation {
            display: block;
            padding: 0.5rem 0;
            line-height: 1.8;
        }

        .arabic-original {
            font-weight: bold;
            color: #3182ce;
        }

        .english-part {
            font-weight: bold;
            color: #805ad5;
            margin: 0 0.25rem;
        }

        .arabic-pronunciation {
            color: #4a5568;
            font-style: italic;
        }

        .equals-sign {
            color: #718096;
            margin: 0 0.25rem;
        }

        .arabic-meaning {
            color: #2d3748;
        }

        /* Action buttons container */
        .action-buttons {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.25rem;
            z-index: 10;
        }

        .action-buttons .icon-button {
            cursor: pointer;
            color: #805ad5;
            font-size: 0.75rem;
            padding: 0.25rem;
            border-radius: 9999px;
            background-color: #f3e8ff;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .action-buttons .icon-button:hover {
            background-color: #e9d8fd;
            color: #6b46c1;
        }

        /* Developer message bubble styles */
        .developer-message-bubble {
            background-color: #e9d8fd;
            color: #6b46c1;
            text-align: center;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            margin: 1rem auto;
            max-width: 70%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }

        .developer-message-bubble.hidden {
            opacity: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #teacherAppSection .chat-container {
                height: 100vh;
                border-radius: 0;
            }
            .chat-header {
                border-radius: 0;
                font-size: 1.25rem;
                padding: 1rem;
            }
            body {
                padding-top: 0;
            }
        }

        /* Custom style for the very narrow contact button */
        #contactButton {
            width: 3rem;
            height: 4rem;
            border-top-left-radius: 1.5rem;
            border-bottom-left-radius: 1.5rem;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            right: 0;
            transform: translateY(-50%) translateX(75%);
            transition: all 0.3s ease-in-out;
            position: fixed; /* تأكد أنها ثابتة في حالتها */
            top: 50%;
            z-index: 40;
        }

        #contactButton:hover {
            transform: translateY(-50%) translateX(0);
            background-color: #4CAF50;
            background-opacity: 1;
        }
        #contactButton i {
            font-size: 1.75rem;
        }
    </style>
</head>
<body>
    <div id="activationSection" class="app-section">
        <div class="container">
            <h2>تفعيل التطبيق</h2>
            <p>معرفك: <span id="identifier"></span></p>
            <input type="text" id="activationCode" placeholder="أدخل كود التفعيل">
            <br>
            <button id="activateButton">تفعيل</button>
            <p id="resultMessage"></p>
            <button id="purchaseDetailsButton" class="small-button">تفاصيل الشراء</button>
        </div>

        <div id="purchaseModal" class="modal">
            <div class="modal-content">
                <span class="close-modal" id="closeModalButton">&times;</span>
                <i class="fab fa-whatsapp whatsapp-icon-large"></i> <h3>احصل على كود التفعيل الآن!</h3>
                <p>
                    <b>احصل على كود التفعيل لمدة سنة كاملة</b><br>
                    بسعر لا يصدق: <span style="color: #25D366; font-weight: bold; font-size: 1.5em; display: block; margin: 10px 0;">فقط 2 دولار!</span>
                </p>
                <a href="https://wa.me/967782343232" target="_blank" class="contact-whatsapp-btn">
                    <i class="fab fa-whatsapp"></i> تواصل معنا عبر واتساب
                </a>
                <p class="contact-info-text">للاستفسارات والدعم: +967782343232</p>
            </div>
        </div>
    </div>

    <div id="teacherAppSection" class="app-section">
        <div class="chat-container">
            <div class="chat-header">
                مدرس اللغة الإنجليزية
            </div>
            <div id="chatHistory" class="chat-history">
                <div class="message-bubble ai">
                    <div class="message-avatar ai">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="action-buttons">
                            <i class="fas fa-volume-up icon-button" title="تشغيل النطق"></i>
                            <i class="fas fa-copy icon-button" title="نسخ النص الإنجليزي"></i>
                        </div>
                        مرحباً! أنا مدرس اللغة الإنجليزية الخاص بك. كيف يمكنني مساعدتك اليوم؟
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <textarea id="userMessageInput" placeholder="اكتب رسالتك هنا..." rows="1"></textarea>
                <button id="sendMessageBtn">
                    <i class="fas fa-paper-plane"></i>
                    إرسال
                </button>
            </div>
        </div>

        <div id="contactButton" class="fixed right-0 top-1/2 transform -translate-y-1/2 w-12 h-16 bg-green-500 bg-opacity-75 hover:bg-opacity-100 rounded-l-full flex items-center justify-center cursor-pointer shadow-lg transition-all duration-300 z-40">
            <i class="fab fa-whatsapp text-white text-2xl"></i>
        </div>

        <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div id="contactModalContent" class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center relative transform transition-all duration-300 scale-95 opacity-0">
                <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl transition-colors duration-200">
                    <i class="fas fa-times"></i>
                </button>
                <div class="flex flex-col items-center justify-center mb-6">
                    <div class="bg-green-100 p-4 rounded-full mb-4">
                        <i class="fab fa-whatsapp text-green-600 text-4xl"></i>
                    </div>
                    <h2 class="text-3xl font-extrabold text-green-800 mb-2">للتواصل والاستفسار</h2>
                    <p class="text-lg text-gray-700">يمكنك التواصل مع المطور عبر واتساب:</p>
                </div>
                <div class="bg-green-50 p-4 rounded-xl mb-6 border border-green-200">
                    <p class="text-2xl font-bold text-green-700 mb-2">
                        <i class="fab fa-whatsapp text-green-600 mr-2"></i>
                        +967782343232
                    </p>
                    <a href="https://wa.me/967782343232" target="_blank" class="inline-block bg-green-600 text-white px-6 py-2 rounded-full text-lg font-semibold hover:bg-green-700 transition-colors duration-300 shadow-md">
                        مراسلة عبر واتساب
                    </a>
                </div>
                <p class="text-sm text-gray-500">
                    نحن هنا لمساعدتك والإجابة على استفساراتك.
                </p>
            </div>
        </div>
    </div>

    <script>
        // دالة لإدارة عرض الأقسام (الواجهات)
        function showSection(sectionId) {
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.remove('active');
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.add('active');
            }
        }

        // JavaScript الخاص بواجهة المستخدم (الآن مع المفتاح الموحد)
        // **هام: المفتاح هنا هو نفس المفتاح في واجهة المطور.**
        const KEY = 'your-strong-secret-key'; 

        let userIdentifier = localStorage.getItem('userIdentifier');
        if (!userIdentifier) {
            userIdentifier = Math.floor(Math.random() * 900000000) + 100000000;
            localStorage.setItem('userIdentifier', userIdentifier);
        }

        document.getElementById('identifier').innerText = userIdentifier;

        function xorEncryptDecrypt(text, key) {
            const keyLength = key.length;
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % keyLength));
            }
            return result;
        }

        function decodeSab80(encodedString) {
            try {
                const decodedText = atob(encodedString);
                return xorEncryptDecrypt(decodedText, KEY);
            } catch (e) {
                console.error('Failed to decode Sab80:', e);
                return null;
            }
        }

        function checkCodeValidity(code, currentDate) {
            const parts = code.split(':');
            if (parts.length !== 2) return false;
            const expiryDate = new Date(parts[1]);
            return expiryDate >= currentDate;
        }

        function activateApp() {
            const activationCode = document.getElementById('activationCode').value;
            const decodedString = decodeSab80(activationCode);
            if (!decodedString) {
                document.getElementById('resultMessage').innerHTML = 'رمز التفعيل غير صالح.';
                return;
            }

            const [identifier, expiryDate] = decodedString.split(':');
            if (identifier !== userIdentifier.toString()) {
                document.getElementById('resultMessage').innerHTML = 'معرف المستخدم غير صالح.';
                return;
            }

            const currentDate = new Date();
            if (checkCodeValidity(decodedString, currentDate)) {
                localStorage.setItem('isAppActivated', 'true');
                localStorage.setItem('expiryDate', expiryDate);
                // عرض واجهة المدرس
                showSection('teacherAppSection');
                // ابدأ عرض رسالة المطور بعد إظهار الواجهة
                setTimeout(showDeveloperMessage, 1000); 
                developerMessageIntervalId = setInterval(showDeveloperMessage, 65 * 1000); 
            } else {
                document.getElementById('resultMessage').innerHTML = 'انتهت صلاحية كود التفعيل.';
            }
        }

        // منطق التحقق الأولي عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            const installationDate = localStorage.getItem('installationDate');
            const currentDate = new Date();

            // إذا لم يكن هناك تاريخ تثبيت، قم بتسجيله الآن (لبدء الفترة التجريبية)
            if (!installationDate) {
                localStorage.setItem('installationDate', currentDate.toISOString());
            }

            const ONE_DAY_IN_MS = 24 * 60 * 60 * 1000; // 24 ساعة بالمللي ثانية
            const storedInstallationDate = new Date(localStorage.getItem('installationDate'));
            const timeElapsed = currentDate.getTime() - storedInstallationDate.getTime();

            const isAppActivated = localStorage.getItem('isAppActivated');
            const expiryDateStr = localStorage.getItem('expiryDate');

            let isCurrentlyActive = false;
            
            // تحقق من الفترة التجريبية (24 ساعة)
            if (timeElapsed < ONE_DAY_IN_MS) {
                isCurrentlyActive = true; 
            } 
            // ثم تحقق من التفعيل المدفوع إذا لم تكن في الفترة التجريبية
            else if (isAppActivated === 'true' && expiryDateStr) {
                const expiryDate = new Date(expiryDateStr);
                if (currentDate <= expiryDate) {
                    isCurrentlyActive = true; 
                }
            }

            if (isCurrentlyActive) {
                showSection('teacherAppSection');
                setTimeout(showDeveloperMessage, 1000); 
                developerMessageIntervalId = setInterval(showDeveloperMessage, 65 * 1000); 
            } else {
                showSection('activationSection');
            }
        });


        // معالجة أحداث الأزرار (تفعيل، فتح/إغلاق مودال الشراء)
        document.getElementById('activateButton').addEventListener('click', activateApp);
        document.getElementById('purchaseDetailsButton').addEventListener('click', function() {
            const modal = document.getElementById('purchaseModal');
            modal.classList.add('show'); // إضافة class لإظهار المودال مع الانتقال
        });
        document.getElementById('closeModalButton').addEventListener('click', function() {
            const modal = document.getElementById('purchaseModal');
            modal.classList.remove('show'); // إزالة class لإخفاء المودال
        });
        // إغلاق المودال عند النقر خارج المحتوى
        document.getElementById('purchaseModal').addEventListener('click', function(event) {
            if (event.target === this) { // إذا تم النقر على الخلفية وليس المحتوى
                this.classList.remove('show');
            }
        });


        // منطق نسخ الأرقام المشفرة (لا توجد أرقام قابلة للنسخ مباشرة في المودال الجديد)
        // تم ترك هذا الكود في مكانه لكنه لن يؤثر على المودال الجديد لأن عناصر "copy-number" لم تعد موجودة في المودال الجديد.
        const copyNumbers = document.querySelectorAll('.copy-number');
        copyNumbers.forEach(function(span) {
            const decoded = atob(span.dataset.encoded);
            span.textContent = decoded;
            span.style.cursor = 'pointer';
            span.onclick = function() {
                navigator.clipboard.writeText(decoded).then(() => {
                    alert('تم نسخ الرقم: ' + decoded);
                });
            };
        });

        // --------------------------------------------------------------------------------------
        // JavaScript الخاص بواجهة المدرس (الشات بوت) - يبدأ هنا
        // --------------------------------------------------------------------------------------

        // DOM elements (لواجهة الشات بوت)
        const chatHistoryDiv = document.getElementById('chatHistory');
        const userMessageInput = document.getElementById('userMessageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const contactButton = document.getElementById('contactButton');
        const contactModal = document.getElementById('contactModal'); // هذا المودال لواجهة المدرس
        const contactModalContent = document.getElementById('contactModalContent'); // هذا المحتوى لواجهة المدرس
        const closeModalBtn = document.getElementById('closeModalBtn'); // هذا الزر لواجهة المدرس


        let chatHistory = [];
        let developerMessageIntervalId; 
        let currentDeveloperMessageElement = null; 

        function addMessageToChat(message, sender) {
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble', sender);

            const avatarDiv = document.createElement('div');
            avatarDiv.classList.add('message-avatar', sender);
            avatarDiv.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');

            if (sender === 'ai' && message.includes('<div class="structured-translation"')) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = message;
                const structuredTranslationDiv = tempDiv.querySelector('.structured-translation');

                if (structuredTranslationDiv) {
                    const actionButtonsDiv = document.createElement('div');
                    actionButtonsDiv.classList.add('action-buttons');

                    const speakerIcon = document.createElement('i');
                    speakerIcon.classList.add('fas', 'fa-volume-up', 'icon-button');
                    speakerIcon.title = 'تشغيل النطق';

                    const copyIcon = document.createElement('i'); // تم تصحيح هذا السطر
                    copyIcon.classList.add('fas', 'fa-copy', 'icon-button');
                    copyIcon.title = 'نسخ النص الإنجليزي';

                    actionButtonsDiv.appendChild(speakerIcon);
                    actionButtonsDiv.appendChild(copyIcon);

                    contentDiv.appendChild(actionButtonsDiv);
                    contentDiv.appendChild(structuredTranslationDiv);

                    const englishPartSpan = structuredTranslationDiv.querySelector('.english-part');
                    if (englishPartSpan) {
                        speakerIcon.addEventListener('click', () => {
                            speakText(englishPartSpan.textContent);
                        });

                        copyIcon.addEventListener('click', () => {
                            copyTextToClipboard(englishPartSpan.textContent);
                        });
                    }
                } else {
                    contentDiv.innerHTML = message;
                }
            } else {
                contentDiv.innerHTML = message;
            }

            messageBubble.appendChild(avatarDiv);
            messageBubble.appendChild(contentDiv);
            chatHistoryDiv.appendChild(messageBubble);

            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        function toggleLoading(show) {
            if (show) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingChatIndicator';
                loadingDiv.classList.add('loading-chat-indicator');
                loadingDiv.innerHTML = `
                    <div class="message-avatar ai">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <svg class="spinner h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>يكتب...</span>
                    </div>
                `;
                chatHistoryDiv.appendChild(loadingDiv);
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            } else {
                const loadingDiv = document.getElementById('loadingChatIndicator');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; 

                const voices = speechSynthesis.getVoices();
                const englishVoices = voices.filter(voice => voice.lang.startsWith('en-'));

                let selectedVoice = englishVoices.find(voice => voice.name === 'Google US English') ||
                                   englishVoices.find(voice => voice.name.includes('English (United States)')) ||
                                   englishVoices.find(voice => voice.default); 

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }

                speechSynthesis.speak(utterance);
            } else {
                console.warn('Web Speech API غير مدعوم في هذا المتصفح.');
                displayMessageBox('عذرًا، متصفحك لا يدعم تحويل النص إلى كلام.');
            }
        }

        function copyTextToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                console.log('Text copied to clipboard:', text);
                displayMessageBox('تم نسخ النص إلى الحافظة!', 'success');
            } catch (err) {
                console.error('Failed to copy text:', err);
                displayMessageBox('عذرًا، فشل نسخ النص. يرجى النسخ يدويًا.', 'error');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function displayMessageBox(message, type = 'info') {
            let messageBox = document.getElementById('customMessageBox');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'customMessageBox';
                messageBox.classList.add('fixed', 'bottom-4', 'left-1/2', '-translate-x-1/2', 'p-3', 'rounded-lg', 'shadow-lg', 'text-white', 'text-center', 'z-50', 'transition-opacity', 'duration-300', 'opacity-0');
                document.body.appendChild(messageBox);
            }

            messageBox.textContent = message;
            messageBox.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500'); 
            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }

            messageBox.classList.add('opacity-100'); 
            setTimeout(() => {
                messageBox.classList.remove('opacity-100'); 
            }, 3000);
        }

        function showDeveloperMessage() {
            if (currentDeveloperMessageElement) {
                currentDeveloperMessageElement.remove();
                currentDeveloperMessageElement = null;
            }

            const devMessageDiv = document.createElement('div');
            devMessageDiv.classList.add('developer-message-bubble');
            devMessageDiv.textContent = 'تم تطوير هذا البوت بواسطة المطور صابر';
            devMessageDiv.id = `dev-msg-${Date.now()}`; 

            chatHistoryDiv.appendChild(devMessageDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

            currentDeveloperMessageElement = devMessageDiv; 

            setTimeout(() => {
                if (devMessageDiv && devMessageDiv.parentNode) {
                    devMessageDiv.classList.add('hidden'); 
                    setTimeout(() => {
                        if (devMessageDiv && devMessageDiv.parentNode) {
                            devMessageDiv.remove(); 
                            currentDeveloperMessageElement = null;
                        }
                    }, 500); 
                }
            }, 5 * 1000); 
        }

        async function sendMessage() {
            const userMessage = userMessageInput.value.trim();
            if (!userMessage) return;

            addMessageToChat(userMessage, 'user');
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            userMessageInput.value = ''; 
            userMessageInput.style.height = 'auto'; 

            toggleLoading(true); 

            try {
                const systemPrompt = {
                    role: "user",
                    parts: [{ text: `أنت مدرس للغة الإنجليزية. هدفك هو مساعدة المستخدمين على ممارسة وتحسين لغتهم الإنجليزية.
يجب أن تكون استجابتك بالكامل دائمًا فقط هي الترجمة المنظمة بتنسيق HTML <div>. لا تضف أي نص حواري آخر أو تفسيرات أو أمثلة قبل أو بعد هذا <div>.
يجب أن يكون التنسيق:
<div class="structured-translation" dir="rtl">
    <span class="arabic-original">[العبارة العربية الأصلية]</span><span class="english-part">[الترجمة الإنجليزية]</span>(<span class="arabic-pronunciation">[النطق الصوتي العربي للإنجليزية]</span>) <span class="equals-sign">=</span> <span class="arabic-meaning">[المعنى العربي]</span>
</div>
إذا كتب المستخدم باللغة العربية، فقدم الأصل العربي، وترجمته الإنجليزية، والنطق الصوتي، والمعنى العربي.
إذا كتب المستخدم باللغة الإنجليزية، فقدم الترجمة العربية لعبارته الإنجليزية، والعبارة الإنجليزية نفسها، ونطقها الصوتي، والمعنى العربي.
مثال على الإخراج المطلوب للغة العربية "انا ذاهب":
<div class="structured-translation" dir="rtl">
    <span class="arabic-original">انا ذاهب</span><span class="english-part">I'm going</span>(<span class="arabic-pronunciation">ايم جوه-ينج</span>) <span class="equals-sign">=</span> <span class="arabic-meaning">أنا ذاهب</span>
</div>
مثال على الإخراج المطلوب للغة الإنجليزية "Hello":
<div class="structured-translation" dir="rtl">
    <span class="arabic-original">مرحبا</span><span class="english-part">Hello</span>(<span class="arabic-pronunciation">هالو</span>) <span class="equals-sign">=</span> <span class="arabic-meaning">أهلاً</span>
</div>
مثال على الإخراج المطلوب للغة العربية "لا تدخن":
<div class="structured-translation" dir="rtl">
    <span class="arabic-original">لا تدخن</span><span class="english-part">Don't smoke</span>(<span class="arabic-pronunciation">دونت سموك</span>) <span class="equals-sign">=</span> <span class="arabic-meaning">لا تدخن</span>
</div>
تأكد من أن النطق الصوتي العربي هو حروف عربية مبسطة، وليس رموز IPA.
تأكد من أن هيكل HTML صالح ومنسق جيدًا.
` }]
                };

                const payload = {
                    contents: [systemPrompt, ...chatHistory]
                };

                const apiKey = "AIzaSyCAtLdN4wO55U9OE-HATmq20tfi5f1TQvw"; // **تأكد من أن هذا المفتاح صالح**
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    addMessageToChat(aiResponse, 'ai');
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                } else {
                    addMessageToChat("عذرًا، لم أتمكن من معالجة ذلك. يرجى المحاولة مرة أخرى.", 'ai');
                }
            } catch (error) {
                console.error('خطأ في استدعاء Gemini API:', error);
                addMessageToChat("حدث خطأ. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.", 'ai');
            } finally {
                toggleLoading(false); 
            }
        }

        function showContactModal() {
            contactModal.classList.remove('hidden');
            void contactModalContent.offsetWidth; 
            contactModalContent.classList.remove('scale-95', 'opacity-0');
            contactModalContent.classList.add('scale-100', 'opacity-100');
        }

        function hideContactModal() {
            contactModalContent.classList.remove('scale-100', 'opacity-100');
            contactModalContent.classList.add('scale-95', 'opacity-0');
            contactModalContent.addEventListener('transitionend', function handler() {
                contactModal.classList.add('hidden');
                contactModalContent.removeEventListener('transitionend', handler); 
            }, { once: true }); 
        }

        sendMessageBtn.addEventListener('click', sendMessage);
        userMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                sendMessage();
            }
        });

        userMessageInput.addEventListener('input', () => {
            userMessageInput.style.height = 'auto';
            userMessageInput.style.height = userMessageInput.scrollHeight + 'px';
        });
 
        contactButton.addEventListener('click', showContactModal);
        closeModalBtn.addEventListener('click', hideContactModal);
        contactModal.addEventListener('click', (e) => {
            if (e.target === contactModal) {
                hideContactModal();
            }
        });
    </script>
</body>
                    </html>
