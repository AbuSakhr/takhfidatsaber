<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدرس اللغة الإنجليزية</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for the chat interface */
        html, body {
            height: 100%; /* Ensure html and body take full height */
            overflow: hidden; /* Prevent scrolling on html/body to manage it within chat-history */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8, #e6eaf0); /* Very subtle, almost white gradient background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            box-sizing: border-box;
        }

        .chat-container {
            background-color: rgba(255, 255, 255, 0.98); /* Even more opaque glassmorphism */
            backdrop-filter: blur(30px); /* Stronger blur for depth */
            border-radius: 2.75rem; /* Even more rounded corners */
            box-shadow: 0 30px 70px rgba(0, 0, 0, 0.2); /* Softer, more diffused shadow */
            width: 100%;
            max-width: 680px; /* Slightly wider for a more spacious feel */
            height: 92vh; /* Slightly taller */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Manage overflow within this container */
            transition: all 0.5s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.5); /* More subtle border */
        }

        .chat-header {
            background: linear-gradient(135deg, #6c5ce7, #8a6de3); /* Vibrant purple gradient */
            color: #ffffff;
            padding: 2rem; /* More padding */
            border-top-left-radius: 2.75rem;
            border-top-right-radius: 2.75rem;
            text-align: center;
            font-size: 2.25rem; /* Larger font */
            font-weight: bold;
            letter-spacing: 0.1em; /* More letter spacing */
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25); /* More pronounced header shadow */
            text-shadow: 0 4px 6px rgba(0,0,0,0.35);
        }

        .chat-history {
            flex-grow: 1;
            padding: 2rem; /* More padding */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.75rem; /* Increased gap between messages */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10rem; /* Add padding to account for fixed input area */
        }

        .message-bubble {
            display: flex;
            align-items: flex-start;
            gap: 1.25rem; /* Increased gap between avatar and message */
            max-width: 90%; /* Wider messages */
            animation: fadeIn 0.6s ease-out; /* Slower, smoother fade in */
        }

        .message-bubble.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-bubble.ai {
            align-self: flex-start;
            flex-direction: row;
        }

        .message-avatar {
            width: 3.25rem; /* Larger avatar */
            height: 3.25rem;
            border-radius: 9999px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.6rem; /* Larger icon */
            color: #ffffff;
            flex-shrink: 0;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25); /* More prominent avatar shadow */
            border: 4px solid rgba(255, 255, 255, 0.7); /* Thicker, more visible border */
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #4a90e2, #63b3ed); /* User avatar gradient */
        }

        .message-avatar.ai {
            background: linear-gradient(135deg, #8a6de3, #a48ef1); /* AI avatar gradient */
        }

        .message-content {
            padding: 1.15rem 1.75rem; /* More padding */
            border-radius: 1.75rem; /* Even more rounded corners for messages */
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.8;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); /* Enhanced shadow for bubbles */
            position: relative;
            transition: all 0.4s ease-in-out;
        }

        .message-bubble.user .message-content {
            background-color: #e0f2fe;
            color: #2d3748;
            border-bottom-right-radius: 0.85rem; /* Softer pointy corner */
        }

        .message-bubble.ai .message-content {
            background-color: #f3e8ff;
            color: #2d3748;
            border-bottom-left-radius: 0.85rem; /* Softer pointy corner */
            padding-top: 2.75rem; /* More space for buttons */
        }

        .chat-input-area {
            display: flex;
            padding: 1.75rem 2rem; /* More padding */
            border-top: 1px solid rgba(255, 255, 255, 0.4);
            background-color: rgba(255, 255, 255, 0.95);
            gap: 1.25rem; /* Increased gap */
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.15);
            position: absolute; /* Changed to absolute for fixed positioning */
            bottom: 0; /* Stick to the bottom */
            width: 100%; /* Full width */
            box-sizing: border-box; /* Include padding in width */
        }

        .chat-input-area textarea {
            flex-grow: 1;
            border: 1px solid #cbd5e0;
            border-radius: 1.25rem; /* More rounded */
            padding: 1.15rem 1.5rem; /* More padding */
            font-size: 1.1rem;
            resize: none;
            min-height: 3.25rem; /* Slightly taller */
            max-height: 200px; /* Increased max height */
            overflow-y: auto;
            transition: all 0.4s ease-in-out;
            background-color: rgba(249, 250, 251, 0.98);
        }

        .chat-input-area textarea:focus {
            outline: none;
            border-color: #6c5ce7;
            box-shadow: 0 0 0 5px rgba(108, 92, 231, 0.4); /* Enhanced focus ring */
        }

        .chat-input-area button {
            background: linear-gradient(135deg, #6c5ce7, #8a6de3); /* Send button gradient */
            color: #ffffff;
            border: none;
            border-radius: 1.25rem; /* More rounded */
            padding: 1.15rem 1.75rem; /* More padding */
            font-size: 1.35rem; /* Larger font */
            cursor: pointer;
            transition: all 0.4s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.7rem; /* Increased gap */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }

        .chat-input-area button:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
        }

        .chat-input-area button:active {
            transform: translateY(0);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
        }

        /* Loading indicator styles */
        .loading-chat-indicator {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            align-self: flex-start;
            max-width: 90%;
            animation: fadeIn 0.5s ease-out;
        }

        .loading-chat-indicator .message-content {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            background-color: #f3e8ff;
            color: #2d3748;
            padding: 1.15rem 1.75rem;
            border-radius: 1.75rem;
            border-bottom-left-radius: 0.85rem;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Structured translation styles */
        .structured-translation {
            display: block;
            padding: 0.75rem 0;
            line-height: 2;
        }

        .arabic-original {
            font-weight: bold;
            color: #3182ce;
        }

        .english-part {
            font-weight: bold;
            color: #8a6de3;
            margin: 0 0.4rem;
        }

        .arabic-pronunciation {
            color: #718096;
            font-style: italic;
            font-size: 1em;
        }

        .equals-sign {
            color: #a0aec0;
            margin: 0 0.4rem;
        }

        .arabic-meaning {
            color: #2d3748;
        }

        /* Action buttons container */
        .action-buttons {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.4rem; /* Increased gap */
            z-index: 10;
        }

        .action-buttons .icon-button {
            cursor: pointer;
            color: #6c5ce7;
            font-size: 0.9rem; /* Slightly larger icon */
            padding: 0.3rem; /* More padding */
            border-radius: 9999px;
            background-color: #f0eaff;
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.8rem; /* Larger button */
            height: 1.8rem;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .action-buttons .icon-button:hover {
            background-color: #e9d8fd;
            color: #5a4ac1;
            transform: translateY(-2px);
        }

        /* Developer message bubble styles */
        .developer-message-bubble {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            color: #6c5ce7;
            text-align: center;
            padding: 1rem 1.5rem;
            border-radius: 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            margin: 1.5rem auto;
            max-width: 80%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
            transition: opacity 0.7s ease-in-out;
            opacity: 1;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .developer-message-bubble.hidden {
            opacity: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }
            .chat-header {
                border-radius: 0;
                font-size: 2rem;
                padding: 1.5rem;
            }
            body {
                padding-top: 0;
            }
            .chat-history {
                padding-bottom: 10rem; /* Ensure enough space for the fixed input area */
            }
            .chat-input-area {
                position: fixed; /* Ensure it stays at the bottom */
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                border-radius: 0;
                padding: 1.5rem 1rem; /* Adjust padding for smaller screens */
            }
        }

        /* Custom style for the very narrow contact button */
        #contactButton {
            width: 4.5rem; /* Even wider */
            height: 5.5rem; /* Even taller */
            border-top-left-radius: 2.25rem; /* More rounded */
            border-bottom-left-radius: 2.25rem;
            right: 0;
            transform: translateY(-50%) translateX(88%); /* Hide more */
            background-color: #25d366;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #contactButton:hover {
            transform: translateY(-50%) translateX(0);
            background-color: #1da851;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }
        #contactButton i {
            font-size: 2.5rem; /* Even larger icon */
        }

        /* New styles for the beautiful pop-up */
        #unlockModal .bg-white, #contactModalContent {
            background-color: rgba(255, 255, 255, 0.99); /* Almost fully opaque white */
            backdrop-filter: blur(25px);
            border-radius: 2.75rem;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.35); /* Deeper, softer shadow */
            padding: 3.5rem; /* More padding */
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .modal-body {
            font-size: 1.25rem;
            line-height: 1.9;
            color: #2d3748; /* Darker gray text */
        }
        
        .modal-link-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #25d366, #1da851); /* Gradient for WhatsApp button */
            color: #ffffff;
            padding: 1.05rem 2.75rem; /* More padding */
            border-radius: 9999px;
            font-size: 1.5rem; /* Larger font */
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(37, 211, 102, 0.6); /* Enhanced shadow */
            transition: all 0.4s ease-in-out;
        }

        .modal-link-button:hover {
            transform: translateY(-5px) scale(1.05); /* More pronounced hover effect */
            box-shadow: 0 15px 35px rgba(37, 211, 102, 0.8);
        }

        .modal-input-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 3rem; /* More margin */
        }

        .modal-input-container i {
            position: absolute;
            right: 1.75rem; /* Adjusted position */
            color: #a0aec0;
            font-size: 2rem; /* Larger icon */
        }
        
        .modal-input {
            padding-right: 4.5rem; /* More space for the icon */
            text-align: right;
            border-radius: 1.25rem; /* More rounded */
            padding-top: 1.15rem; /* More vertical padding */
            padding-bottom: 1.15rem;
            font-size: 1.2rem;
            background-color: rgba(249, 250, 251, 0.99);
            border: 1px solid #c7ced6;
        }

        #unlockButton {
            background: linear-gradient(135deg, #6c5ce7, #8a6de3); /* Gradient for unlock button */
            padding: 1.15rem 2rem;
            border-radius: 1.75rem;
            font-size: 1.45rem;
            box-shadow: 0 10px 30px rgba(108, 92, 231, 0.6);
            transition: all 0.4s ease-in-out;
        }

        #unlockButton:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 35px rgba(108, 92, 231, 0.8);
        }

        #closeModalBtn {
            font-size: 3rem;
            color: #a0aec0;
            transition: all 0.4s ease-in-out;
        }

        #closeModalBtn:hover {
            color: #718096;
            transform: rotate(270deg); /* Full rotation on hover */
        }

        /* Custom message box styles */
        #customMessageBox {
            bottom: 3rem;
            padding: 1.15rem 2rem;
            border-radius: 2rem;
            font-size: 1.15rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
            transform: translate(-50%, 30px);
            opacity: 0;
            background: linear-gradient(135deg, #6c5ce7, #8a6de3);
        }

        #customMessageBox.opacity-100 {
            transform: translate(-50%, 0);
        }

    </style>
</head>
<body>
    <div id="unlockModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center transform scale-100 transition-all duration-300">
            <div class="flex flex-col items-center justify-center mb-6">
                <div class="bg-green-100 p-4 rounded-full mb-4">
                    <i class="fab fa-whatsapp text-green-600 text-4xl"></i>
                </div>
                <h2 class="text-3xl font-extrabold text-gray-800 mb-2">مرحباً بك!</h2>
                <p class="text-lg text-gray-700 leading-relaxed modal-body">
                    للدخول إلى البوت، يرجى منك **متابعة قناة البوت** والحصول على الرقم الموجود بجانب اسم القناة وإدخاله في الحقل المخصص بالأسفل.
                </p>
                <a href="https://whatsapp.com/channel/0029VbAQz2tKAwEsMzpWJI3y" target="_blank" class="mt-6 modal-link-button">
                    <i class="fab fa-whatsapp ml-2"></i>
                    متابعة القناة
                </a>
            </div>
            <div class="mb-4 mt-8 modal-input-container">
                <input type="text" id="unlockCodeInput" placeholder="أدخل رقم البوت" class="w-full text-center px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-purple-500 transition-colors modal-input" maxlength="5">
                <i class="fas fa-key"></i>
                <p id="unlockErrorMsg" class="text-red-500 mt-2 hidden">الرقم غير صحيح. يرجى التأكد من الرقم والمحاولة مرة أخرى.</p>
            </div>
            <button id="unlockButton" class="w-full bg-purple-600 text-white px-6 py-3 rounded-xl text-xl font-bold hover:bg-purple-700 transition-colors duration-300 shadow-md">
                الدخول إلى البوت
            </button>
        </div>
    </div>

    <div id="mainContent" class="chat-container hidden">
        <div class="chat-header">
            مدرس اللغة الإنجليزية
        </div>
        <div id="chatHistory" class="chat-history">
            <!-- Chat messages will be appended here -->
        </div>
        <div class="chat-input-area">
            <textarea id="userMessageInput" placeholder="اكتب رسالتك هنا..." rows="1"></textarea>
            <button id="sendMessageBtn">
                <i class="fas fa-paper-plane"></i>
                إرسال
            </button>
        </div>
    </div>

    <!-- Floating Contact Button -->
    <div id="contactButton" class="fixed right-0 top-1/2 transform -translate-y-1/2 w-12 h-16 bg-green-500 bg-opacity-75 hover:bg-opacity-100 rounded-l-full flex items-center justify-center cursor-pointer shadow-lg transition-all duration-300 z-40 hidden">
        <i class="fab fa-whatsapp text-white text-2xl"></i>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div id="contactModalContent" class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center relative transform transition-all duration-300 scale-95 opacity-0">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl transition-colors duration-200">
                <i class="fas fa-times"></i>
            </button>
            <div class="flex flex-col items-center justify-center mb-6">
                <div class="bg-green-100 p-4 rounded-full mb-4">
                    <i class="fab fa-whatsapp text-green-600 text-4xl"></i>
                </div>
                <h2 class="text-3xl font-extrabold text-green-800 mb-2">للتواصل والاستفسار</h2>
                <p class="text-lg text-gray-700 leading-relaxed">
                    يمكنك التواصل معنا عبر الواتساب للحصول على الدعم أو الاستفسارات.
                </p>
                <a href="https://wa.me/+967782343232" target="_blank" class="mt-6 modal-link-button">
                    <i class="fab fa-whatsapp ml-2"></i>
                    تواصل عبر الواتساب
                </a>
            </div>
        </div>
    </div>

    <script>
        const unlockModal = document.getElementById("unlockModal");
        const unlockCodeInput = document.getElementById("unlockCodeInput");
        const unlockButton = document.getElementById("unlockButton");
        const unlockErrorMsg = document.getElementById("unlockErrorMsg");
        const mainContent = document.getElementById("mainContent");
        const chatHistoryDiv = document.getElementById("chatHistory");
        const userMessageInput = document.getElementById("userMessageInput");
        const sendMessageBtn = document.getElementById("sendMessageBtn");
        const contactButton = document.getElementById("contactButton");
        const contactModal = document.getElementById("contactModal");
        const contactModalContent = document.getElementById("contactModalContent");
        const closeModalBtn = document.getElementById("closeModalBtn");

        let chatHistory = [];
        let developerMessageIntervalId = null;
        let currentDeveloperMessageElement = null; // To keep track of the currently displayed dev message

        // Correct unlock code (replace with your actual code)
        const CORRECT_UNLOCK_CODE = "12345"; 

        unlockButton.addEventListener("click", () => {
            if (unlockCodeInput.value === CORRECT_UNLOCK_CODE) {
                unlockErrorMsg.classList.add("hidden");
                startBot();
            } else {
                unlockErrorMsg.classList.remove("hidden");
            }
        });

        // Allow pressing Enter in the unlock code input
        unlockCodeInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                unlockButton.click();
            }
        });

        /**
         * Adds a message to the chat history.
         * @param {string} message - The message text.
         * @param {"user"|"ai"} sender - The sender of the message ("user" or "ai").
         */
        function addMessageToChat(message, sender) {
            const messageBubble = document.createElement("div");
            messageBubble.classList.add("message-bubble", sender);

            const avatarDiv = document.createElement("div");
            avatarDiv.classList.add("message-avatar", sender);
            avatarDiv.innerHTML = sender === "user" ? "<i class=\"fas fa-user\"></i>" : "<i class=\"fas fa-robot\"></i>";

            const contentDiv = document.createElement("div");
            contentDiv.classList.add("message-content");

            // Check if the message is a structured translation from the AI
            if (sender === "ai" && message.includes("<div class=\"structured-translation\"")) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(message, "text/html");
                const structuredTranslationDiv = doc.querySelector(".structured-translation");

                if (structuredTranslationDiv) {
                    // Create action buttons container
                    const actionButtonsDiv = document.createElement("div");
                    actionButtonsDiv.classList.add("action-buttons");

                    // Create speaker icon
                    const speakerIcon = document.createElement("i");
                    speakerIcon.classList.add("fas", "fa-volume-up", "icon-button");
                    speakerIcon.title = "تشغيل النطق";

                    // Create copy icon
                    const copyIcon = document.createElement("i");
                    copyIcon.classList.add("fas", "fa-copy", "icon-button");
                    copyIcon.title = "نسخ النص الإنجليزي";

                    // Append icons to action buttons container
                    actionButtonsDiv.appendChild(speakerIcon);
                    actionButtonsDiv.appendChild(copyIcon);

                    // Append action buttons to contentDiv first
                    contentDiv.appendChild(actionButtonsDiv);
                    // Then append the structured translation
                    contentDiv.appendChild(structuredTranslationDiv);

                    const englishPartSpan = structuredTranslationDiv.querySelector(".english-part");
                    if (englishPartSpan) {
                        // Add event listener for speaker icon
                        speakerIcon.addEventListener("click", () => {
                            speakText(englishPartSpan.textContent);
                        });

                        // Add event listener for copy icon
                        copyIcon.addEventListener("click", () => {
                            copyTextToClipboard(englishPartSpan.textContent);
                        });
                    }
                } else {
                    // Fallback if structured div not found but expected
                    contentDiv.innerHTML = message;
                }
            } else {
                // For regular messages or user messages
                contentDiv.innerHTML = message;
            }

            messageBubble.appendChild(avatarDiv);
            messageBubble.appendChild(contentDiv);
            chatHistoryDiv.appendChild(messageBubble);

            // Scroll to the bottom of the chat history
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        /**
         * Toggles the loading indicator visibility.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleLoading(show) {
            if (show) {
                const loadingDiv = document.createElement("div");
                loadingDiv.id = "loadingChatIndicator";
                loadingDiv.classList.add("loading-chat-indicator");
                loadingDiv.innerHTML = `
                    <div class="message-avatar ai">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <svg class="spinner h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>يكتب...</span>
                    </div>
                `;
                chatHistoryDiv.appendChild(loadingDiv);
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            } else {
                const loadingDiv = document.getElementById("loadingChatIndicator");
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }
        }

        /**
         * Speaks the given text using the Web Speech API.
         * Attempts to find a suitable English voice.
         * @param {string} text - The text to speak.
         */
        function speakText(text) {
            if ("speechSynthesis" in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = "en-US"; // Set language to US English

                // Try to find a suitable English voice (preferring male/female)
                const voices = speechSynthesis.getVoices();
                const englishVoices = voices.filter(voice => voice.lang.startsWith("en-"));

                // Prioritize "Google US English" or similar clear voices
                let selectedVoice = englishVoices.find(voice => voice.name === "Google US English") ||
                                   englishVoices.find(voice => voice.name.includes("English (United States)")) ||
                                   englishVoices.find(voice => voice.default); // Fallback to default English voice

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }

                speechSynthesis.speak(utterance);
            } else {
                console.warn("Web Speech API غير مدعوم في هذا المتصفح.");
                displayMessageBox("عذرًا، متصفحك لا يدعم تحويل النص إلى كلام.");
            }
        }

        /**
         * Copies the given text to the clipboard.
         * @param {string} text - The text to copy.
         */
        function copyTextToClipboard(text) {
            const textarea = document.createElement("textarea");
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand("copy");
                console.log("Text copied to clipboard:", text);
                displayMessageBox("تم نسخ النص إلى الحافظة!", "success");
            } catch (err) {
                console.error("Failed to copy text:", err);
                displayMessageBox("عذرًا، فشل نسخ النص. يرجى النسخ يدويًا.", "error");
            } finally {
                document.body.removeChild(textarea);
            }
        }

        /**
         * Displays a custom message box.
         * @param {string} message - The message to display.
         * @param {"success"|"error"|"info"} type - The type of message (for styling).
         */
        function displayMessageBox(message, type = "info") {
            let messageBox = document.getElementById("customMessageBox");
            if (!messageBox) {
                messageBox = document.createElement("div");
                messageBox.id = "customMessageBox";
                messageBox.classList.add("fixed", "bottom-4", "left-1/2", "-translate-x-1/2", "p-3", "rounded-lg", "shadow-lg", "text-white", "text-center", "z-50", "transition-opacity", "duration-300", "opacity-0");
                document.body.appendChild(messageBox);
            }

            messageBox.textContent = message;
            messageBox.classList.remove("bg-green-500", "bg-red-500", "bg-blue-500"); // Clear previous types
            if (type === "success") {
                messageBox.classList.add("bg-green-500");
            } else if (type === "error") {
                messageBox.classList.add("bg-red-500");
            } else {
                messageBox.classList.add("bg-blue-500");
            }

            messageBox.classList.add("opacity-100"); // Show message
            setTimeout(() => {
                messageBox.classList.remove("opacity-100"); // Hide after 3 seconds
            }, 3000);
        }

        /**
         * Shows the developer message as a temporary bubble in the chat history.
         */
        function showDeveloperMessage() {
            // If there's a currently displayed developer message, remove it first
            if (currentDeveloperMessageElement) {
                currentDeveloperMessageElement.remove();
                currentDeveloperMessageElement = null;
            }

            const devMessageDiv = document.createElement("div");
            devMessageDiv.classList.add("developer-message-bubble");
            devMessageDiv.textContent = "تم تطوير هذا البوت بواسطة المطور صابر";
            devMessageDiv.id = `dev-msg-${Date.now()}`; // Unique ID for removal

            chatHistoryDiv.appendChild(devMessageDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

            currentDeveloperMessageElement = devMessageDiv; // Store reference

            // Hide the message after 5 seconds
            setTimeout(() => {
                if (devMessageDiv && devMessageDiv.parentNode) {
                    devMessageDiv.classList.add("hidden"); // Add fade out class
                    setTimeout(() => {
                        if (devMessageDiv && devMessageDiv.parentNode) {
                            devMessageDiv.remove(); // Remove from DOM after fade out
                            currentDeveloperMessageElement = null;
                        }
                    }, 500); // Wait for fade out transition (0.5s)
                }
            }, 5 * 1000);
        }

        /**
         * Sends the user's message to the Gemini API and handles the response.
         */
        async function sendMessage() {
            const userMessage = userMessageInput.value.trim();
            if (!userMessage) return;

            addMessageToChat(userMessage, "user");
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            userMessageInput.value = ""; // Clear the input field
            userMessageInput.style.height = "auto"; // Reset textarea height

            toggleLoading(true); // Show loading indicator

            try {
                // System prompt to define the AI's role as an English language tutor with a very specific translation format
                const systemPrompt = {
                    role: "user",
                    parts: [{ text: `أنت مدرس للغة الإنجليزية. هدفك هو مساعدة المستخدمين على ممارسة وتحسين لغتهم الإنجليزية.\nيجب أن تكون استجابتك بالكامل دائمًا فقط هي الترجمة المنظمة بتنسيق HTML <div>. لا تضف أي نص حواري آخر أو تفسيرات أو أمثلة قبل أو بعد هذا <div>.\nيجب أن يكون التنسيق:\n<div class="structured-translation" dir="rtl">\n    <span class="arabic-original">[العبارة العربية الأصلية]</span><span class="english-part">[الترجمة الإنجليزية]</span>(<span class="arabic-pronunciation">[النطق الصوتي العربي للإنجليزية]</span>) <span class="equals-sign">=</span> <span class="arabic-meaning">[المعنى العربي]</span>\n</div>\nإذا كتب المستخدم باللغة العربية، فقدم الأصل العربي، وترجمته الإنجليزية، والنطق الصوتي، والمعنى العربي.\nإذا كتب المستخدم باللغة الإنجليزية، فقدم الترجمة العربية لعبارته الإنجليزية، والعبارة الإنجليزية نفسها، ونطقها الصوتي، والمعنى العربي.\nمثال على الإخراج المطلوب للغة العربية "انا ذاهب":\n<div class="structured-translation" dir="rtl">\n    <span class="arabic-original">انا ذاهب</span><span class="english-part">I'm going</span>(<span class="arabic-pronunciation">ايم جوه-ينج</span>) <span class="equals-sign">=</span> <span class="arabic-meaning">أنا ذاهب</span>\n</div>\nمثال على الإخراج المطلوب للغة الإنجليزية "Hello":\n<div class="structured-translation" dir="rtl">\n    <span class="arabic-original">مرحبا</span><span class="english-part">Hello</span>(<span class="arabic-pronunciation">هالو</span>) <span class="equals-sign">=</span> <span class="arabic-meaning">أهلاً</span>\n</div>\nمثال على الإخراج المطلوب للغة العربية "لا تدخن":\n<div class="structured-translation" dir="rtl">\n    <span class="arabic-original">لا تدخن</span><span class="english-part">Don't smoke</span>(<span class="arabic-pronunciation">دونت سموك</span>) <span class="equals-sign">=</span> <span class="arabic-meaning">لا تدخن</span>\n</div>\nتأكد من أن النطق الصوتي العربي هو حروف عربية مبسطة، وليس رموز IPA.\nتأكد من أن هيكل HTML صالح ومنسق جيدًا.\n` }]
                };

                // Merge system prompt with chat history for API call
                const payload = {
                    contents: [systemPrompt, ...chatHistory]
                };

                // Add the API key here
                const apiKey = "AIzaSyDuaMIc4g0f7b3MQu40NYTQe23HzvXvBQs";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    addMessageToChat(aiResponse, "ai");
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                } else {
                    addMessageToChat("عذرًا، لم أتمكن من معالجة ذلك. يرجى المحاولة مرة أخرى.", "ai");
                }
            } catch (error) {
                console.error("خطأ في استدعاء Gemini API:", error);
                addMessageToChat("حدث خطأ. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.", "ai");
            } finally {
                toggleLoading(false); // Hide loading indicator
            }
        }

        // Function to show the contact modal with a smooth transition
        function showContactModal() {
            contactModal.classList.remove("hidden");
            // Trigger reflow to ensure transition plays
            void contactModalContent.offsetWidth; // This forces a reflow
            contactModalContent.classList.remove("scale-95", "opacity-0");
            contactModalContent.classList.add("scale-100", "opacity-100");
        }

        // Function to hide the contact modal with a smooth transition
        function hideContactModal() {
            contactModalContent.classList.remove("scale-100", "opacity-100");
            contactModalContent.classList.add("scale-95", "opacity-0");
            // Wait for transition to complete before hiding fully
            contactModalContent.addEventListener("transitionend", function handler() {
                contactModal.classList.add("hidden");
                contactModalContent.removeEventListener("transitionend", handler); // Clean up event listener
            }, { once: true }); // Ensure the event listener runs only once
        }

        /**
         * The function that starts the main bot functionality.
         */
        function startBot() {
            // Show the main chat interface
            mainContent.classList.remove("hidden");
            contactButton.classList.remove("hidden");
            unlockModal.classList.add("hidden");

            // Add the initial welcome message from the AI
            addMessageToChat("مرحباً! أنا مدرس اللغة الإنجليزية الخاص بك. كيف يمكنني مساعدتك اليوم؟", "ai");

            // Start showing the developer message periodically
            showDeveloperMessage(); // Show immediately on load
            developerMessageIntervalId = setInterval(showDeveloperMessage, 65 * 1000);
        }

        // Event listeners for sending messages
        sendMessageBtn.addEventListener("click", sendMessage);
        userMessageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) { // Send on Enter, allow Shift+Enter for new line
                e.preventDefault(); // Prevent new line
                sendMessage();
            }
        });

        // Dynamically adjust textarea height
        userMessageInput.addEventListener("input", () => {
            userMessageInput.style.height = "auto";
            userMessageInput.style.height = userMessageInput.scrollHeight + "px";
        });

        // Event listeners for the new contact button and modal
        contactButton.addEventListener("click", showContactModal);
        closeModalBtn.addEventListener("click", hideContactModal);
        // Close modal if clicking outside the content area
        contactModal.addEventListener("click", (e) => {
            if (e.target === contactModal) {
                hideContactModal();
            }
        });

        // Initial call to set up voices for speech synthesis
        // This is important because getVoices() might return an empty array initially
        // if called before the voices are loaded.
        if ("speechSynthesis" in window) {
            speechSynthesis.onvoiceschanged = () => {
                console.log("Voices changed. Ready for speech synthesis.");
            };
        }

    </script>
</body>
</html>


